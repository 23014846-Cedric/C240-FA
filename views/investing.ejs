<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Investing Coach</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/styles.css" />

  <style>
    /* Video container styling */
    .video-wrapper {
      position: relative;
      width: 100%;
      padding-top: 56.25%; /* 16:9 */
      border-radius: 16px;
      overflow: hidden;
      border: 1px solid #233055;
      background: lightblue;
    }

    .video-wrapper video {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
    }

    /* Simple agent UI styling (matches your card layout) */
    .agent-output {
      border: 1px solid lightblue;
      background: lightblue;
      border-radius: 12px;
      padding: 12px;
      min-height: 80px;
      white-space: pre-wrap;
      line-height: 1.35;
    }

    .agent-row {
      display: flex;
      gap: 10px;
      margin-top: 12px;
    }

    .agent-row input {
      flex: 1;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid lightblue;
      outline: none;
    }
  </style>
</head>

<body>
  <%- include("partials/navbar") %>
  <div class="container">

    <header class="page-header">
      <h1>Investing Coach</h1>
      <p class="subtitle">Simple ETF-based investing guidance for beginners.</p>
    </header>

    <!-- Walkthrough Video -->
    <div class="card">
      <h3 class="card-title">üì∫ How to Use Investing Coach</h3>

      <div class="video-wrapper">
        <video controls preload="metadata">
          <!-- NOTE: if your video is in /public/videos, use /videos/... -->
          <source src="/videos/Investing Coach Guide.mp4" type="video/mp4" />
          Your browser does not support the video tag.
        </video>
      </div>
    </div>

    <!-- Inputs -->
    <div class="card">
      <h3 class="card-title">Your Inputs</h3>

      <div class="form-grid">
        <div>
          <label for="goal">Investment Goal</label>
          <select id="goal">
            <option value="long">Long-term (10+ years)</option>
            <option value="mid">Medium-term (5‚Äì10 years)</option>
            <option value="short">Short-term (0‚Äì5 years)</option>
          </select>
        </div>

        <div>
          <label for="risk">Risk Tolerance</label>
          <select id="risk">
            <option value="low">Low</option>
            <option value="medium">Medium</option>
            <option value="high">High</option>
          </select>
        </div>

        <div class="full">
          <label for="amount">Monthly Investment (SGD)</label>
          <input type="number" id="amount" value="300" min="0" />
        </div>
      </div>

      <div class="actions">
        <button type="button" onclick="generate()">Generate Plan</button>
        <button type="button" class="btn-secondary" onclick="copyPlan()">Copy Plan</button>
      </div>

      <div id="toast" class="toast" aria-live="polite"></div>
    </div>

    <!-- Plan -->
    <div class="card">
      <div class="plan-header">
        <h3 class="card-title">Your Plan</h3>
        <span class="badge">Educational</span>
      </div>
      <pre id="plan">Click ‚ÄúGenerate Plan‚Äù to create a plan.</pre>
    </div>

    <!-- Bottom "ChatAgent" (custom UI) -->
    <div class="card">
      <h3 class="card-title">ü§ñ Ask the Investing Agent</h3>
      <p class="subtitle" style="margin-top: -8px;">
        Type a question and the agent will reply below.
      </p>

      <div id="agentReply" class="agent-output">
        Ask anything like ‚ÄúWhat is DCA?‚Äù or ‚ÄúHow should I start investing?‚Äù
      </div>

      <div class="agent-row">
        <input
          id="agentMsg"
          placeholder="Type your question..."
          autocomplete="off"
          onkeydown="if(event.key==='Enter'){ event.preventDefault(); askAgent(); }"
        />
        <button type="button" onclick="askAgent()">Send</button>
      </div>
    </div>
  </div>

  <script>
    // ---------- Your existing plan generator ----------
    function generate() {
      const goal = document.getElementById("goal").value;
      const risk = document.getElementById("risk").value;
      const amt = document.getElementById("amount").value;

      const equityPct =
        risk === "high" ? "80‚Äì100%" : risk === "medium" ? "60‚Äì70%" : "40‚Äì50%";

      document.getElementById("plan").textContent =
`Profile Summary
----------------
Goal: ${goal}
Risk: ${risk}

Suggested Simple Portfolio
- Equity ETFs: ${equityPct}
- Bond Funds: remainder
- Cash: small buffer

Step-by-step:
1. Open brokerage account
2. Buy ETFs monthly (DCA)
3. Invest SGD ${amt}/month
4. Rebalance once a year

(Educational only, not financial advice)`;
    }

    async function copyPlan() {
      const planText = document.getElementById("plan").textContent || "";
      if (!planText.trim()) return;

      const toast = document.getElementById("toast");
      try {
        await navigator.clipboard.writeText(planText);
        toast.textContent = "Copied to clipboard ‚úÖ";
      } catch (e) {
        const temp = document.createElement("textarea");
        temp.value = planText;
        document.body.appendChild(temp);
        temp.select();
        document.execCommand("copy");
        document.body.removeChild(temp);
        toast.textContent = "Copied ‚úÖ";
      }

      toast.classList.add("show");
      setTimeout(() => toast.classList.remove("show"), 1400);
    }

    // ---------- Bottom "ChatAgent" -> calls Flowise REST API ----------
    // This uses your chatagent chatflowid: 398a071d-8448-4214-b34b-7cde7ca1c1c9
    async function askAgent() {
      const msgEl = document.getElementById("agentMsg");
      const outEl = document.getElementById("agentReply");

      const question = (msgEl.value || "").trim();
      if (!question) return;

      outEl.textContent = "Thinking...";
      msgEl.value = "";

      try {
        const res = await fetch(
          "https://flowise-production-ee50.up.railway.app/api/v1/prediction/398a071d-8448-4214-b34b-7cde7ca1c1c9",
          {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ question })
          }
        );

        const data = await res.json();

        // Flowise commonly returns { text: "..."}; sometimes { answer: "..."} or other shapes.
        const reply =
          data.text ||
          data.answer ||
          data.response ||
          (typeof data === "string" ? data : JSON.stringify(data, null, 2));

        outEl.textContent = reply;
      } catch (e) {
        outEl.textContent =
          "Error contacting agent. Please check your Flowise apiHost and chatflow ID.";
      }
    }
  </script>

  <!-- Floating Flowise Chatbot Widget (ONLY ONE init here) -->
  <!-- This uses your chatbot chatflowid: 3cff5c06-4f53-4fc3-8791-be5514a32a03 -->
  <script type="module">
    import Chatbot from "https://cdn.jsdelivr.net/npm/flowise-embed/dist/web.js";
    Chatbot.init({
      chatflowid: "3cff5c06-4f53-4fc3-8791-be5514a32a03",
      apiHost: "https://flowise-production-ee50.up.railway.app",
    });
  </script>
</body>
</html>
